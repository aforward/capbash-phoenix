#!/bin/bash
source ./bits/bootstrap/logging

#-----------
# Configurations
#-----------

LAUNCHER_OWNER=${LAUNCHER_OWNER-$USER}

ELIXIR_VERSION=${ELIXIR_VERSION-v1.0.0}
PHOENIX_VERSION=${PHOENIX_VERSION-v0.10.0}

export LAUNCHER_DIR=${LAUNCHER_DIR-/var/local}
export PHOENIX_LAUNCHER_DIR=${PHOENIX_LAUNCHER_DIR-$LAUNCHER_DIR/apps/${PHOENIX_NAME}}
export PHOENIX_PROXY_PORT=${PHOENIX_PROXY_PORT-80}
PHOENIX_REPO=${PHOENIX_REPO-git@github.com:capbash/samplephoenix.git}
PHOENIX_MODE=${PHOENIX_MODE-as_is} # supports as_is, nginx
PHOENIX_APP_PORT=${PHOENIX_INTERNAL_PORT-$PHOENIX_HTTP_PORT}
PHOENIX_SERVER_NAMES=${PHOENIX_SERVER_NAMES-_}
PHOENIX_BRANCH=${PHOENIX_BRANCH-master}
PHOENIX_TAG=${PHOENIX_TAG-$PHOENIX_BRANCH}
PHOENIX_SERVER=${PHOENIX_SERVER-phoenix.server} # old apps use phoenix.start

PHOENIX_INCLUDE_POSTGRES=${PHOENIX_INCLUDE_POSTGRES-true}

export PHOENIX_HTTP_PORT=${PHOENIX_HTTP_PORT-80}
export PHOENIX_SSL_PORT=${PHOENIX_SSL_PORT-443}
export PHOENIX_NAME=${PHOENIX_NAME-samplephoenix}

export LOG_DIR=${LOG_DIR-/var/log}
export NGINX_LOG_DIR=${GIT_LOG_DIR-$LOG_DIR/nginx}
export NGINX_SITES_ENABLED_DIR=${NGINX_SITES_ENABLED_DIR-/etc/nginx/sites-enabled}
export NGINX_LAUNCHER_DIR=${NGINX_LAUNCHER_DIR-$LAUNCHER_DIR/nginx}

#-----------
# Install Script
#-----------

notify "Installing phoenix app $PHOENIX_NAME..."

ELIXIR_VERSION=$ELIXIR_VERSION ./bits/elixir/install

OWNER=$LAUNCHER_OWNER ./bits/bootstrap/mkdir PHOENIX_LAUNCHER_DIR $PHOENIX_LAUNCHER_DIR/bin

OWNER=$LAUNCHER_OWNER \
  TEMPLATE=./bits/phoenix/files/bin \
  LOCATION=$PHOENIX_LAUNCHER_DIR/bin \
  ./bits/docker/copyallif \
  @PHOENIX_SERVER@ $PHOENIX_SERVER

OWNER=$LAUNCHER_OWNER \
  TEMPLATE=./bits/phoenix/files/phoenix.dockerfile \
  LOCATION=$PHOENIX_LAUNCHER_DIR/Dockerfile \
  ./bits/docker/copyif \
  @PHOENIX_SERVER@ $PHOENIX_SERVER \
  @ELIXIR_VERSION@ $ELIXIR_VERSION \
  @PHOENIX_PROXY_PORT@ $PHOENIX_PROXY_PORT

GIT_URL=$PHOENIX_REPO \
  GIT_OWNER=$LAUNCHER_OWNER \
  GIT_APPS_DIR=$PHOENIX_LAUNCHER_DIR \
  GIT_REPO_NAME=webapp \
  GIT_BRANCH=$PHOENIX_BRANCH GIT_TAG=$PHOENIX_TAG \
  ./bits/git/install

TEMPLATE=./bits/phoenix/files/.dockerignore \
  LOCATION=$PHOENIX_LAUNCHER_DIR/.dockerignore \
  ./bits/docker/copyif

if [[ "$PHOENIX_INCLUDE_POSTGRES" == true ]]; then
  debug "  -- enabling postgres"
  sed -i 's|# @POSTGRES_INSTALL@|cat ./bits/phoenix/files/postgres_partial.dockerfile|e' $PHOENIX_LAUNCHER_DIR/Dockerfile
  export POSTGRES_LINK_CMD="--link postgres:db"
else
  export POSTGRES_LINK_CMD=""
fi

LAUNCHER_DIR=$PHOENIX_LAUNCHER_DIR NAME=${PHOENIX_NAME} VERSION=$PHOENIX_TAG ./bits/docker/build
NAME=$PHOENIX_NAME VERSION=$PHOENIX_TAG DIR=$PHOENIX_LAUNCHER_DIR BIT=phoenix ./bits/docker/helpers

if [[ "$PHOENIX_MODE" == "nginx" ]]; then
  NAME=$PHOENIX_NAME LAUNCHER_OWNER=$LAUNCHER_OWNER ./bits/nginx/helpers
  OWNER=$LAUNCHER_OWNER \
    TEMPLATE=./bits/phoenix/files/nginx.conf \
    LOCATION=$NGINX_SITES_ENABLED_DIR/$PHOENIX_NAME \
    ./bits/docker/copyif \
    @PHOENIX_NAME@ $PHOENIX_NAME \
    @PHOENIX_APP_PORT@ $PHOENIX_APP_PORT \
    @PHOENIX_SERVER_NAMES@ $PHOENIX_SERVER_NAMES \
    @SERVER_LOGS@ $SERVER_LOGS
fi

notify "DONE, Installing phoenix app $PHOENIX_NAME."